use crate::error;
use serde;
use serde::Deserialize;
use serde_json;
#[derive(Deserialize)]
struct Caption {
    #[serde(rename(deserialize = "baseUrl"))]
    base_url: String,
    #[serde(rename(deserialize = "languageCode"))]
    lang_code: String,
}

#[derive(Deserialize)]
struct Captions {
    captionTracks: Vec<Caption>,
}

trait ProcessHTML<'a> {
    fn html_string(&self) -> &'a str;
    fn captions<'b>(&self, from: &'b str, to: &'b str) -> Result<Caption, error::Error> {
        let html = self.html_string();
        let start = html
            .split_once(from)
            .ok_or_else(|| error::Error::ParseError(format!("Cannot parse html for: {}", from)))?
            .1;
        let actual_json = start
            .split_once(to)
            .ok_or_else(|| error::Error::ParseError(format!("Cannot parse html to: {}", to)))?
            .0;
        let value: Captions = serde_json::from_str(actual_json)
            .map_err(|x| error::Error::ParseError(format!("{}", x)))?;
        let caption = value
            .captionTracks
            .into_iter()
            .filter(|x| x.lang_code == "en")
            .next()
            .ok_or(error::Error::ParseError("Cannot find lang en".into()))?;
        Ok(caption)
    }
}

#[cfg(test)]
mod test {
    use super::*;
    use crate::Config;
    struct HTML;

    impl ProcessHTML<'_> for HTML {
        fn html_string(&self) -> &'static str {
            r#""elapsedMediaTimeSeconds": 0 } }, "captions": { "playerCaptionsTracklistRenderer": { "captionTracks": [{ "baseUrl": "https://www.youtube.com/api/timedtext?v=GJLlxj_dtq8\u0026caps=asr\u0026xoaf=5\u0026hl=en-GB\u0026ip=0.0.0.0\u0026ipbits=0\u0026expire=1681082354\u0026sparams=ip,ipbits,expire,v,caps,xoaf\u0026signature=13D068D838F3B1262B96D29751914C9E75100C4C.A99B64907A100E2E5F74ACE0BA586FB82F865CE3\u0026key=yt8\u0026lang=zh", "name": { "simpleText": "Chinese" }, "vssId": ".zh", "languageCode": "zh", "isTranslatable": true }, { "baseUrl": "https://www.youtube.com/api/timedtext?v=GJLlxj_dtq8\u0026caps=asr\u0026xoaf=5\u0026hl=en-GB\u0026ip=0.0.0.0\u0026ipbits=0\u0026expire=1681082354\u0026sparams=ip,ipbits,expire,v,caps,xoaf\u0026signature=13D068D838F3B1262B96D29751914C9E75100C4C.A99B64907A100E2E5F74ACE0BA586FB82F865CE3\u0026key=yt8\u0026lang=cs", "name": { "simpleText": "Czech" }, "vssId": ".cs", "languageCode": "cs", "isTranslatable": true }, { "baseUrl": "https://www.youtube.com/api/timedtext?v=GJLlxj_dtq8\u0026caps=asr\u0026xoaf=5\u0026hl=en-GB\u0026ip=0.0.0.0\u0026ipbits=0\u0026expire=1681082354\u0026sparams=ip,ipbits,expire,v,caps,xoaf\u0026signature=13D068D838F3B1262B96D29751914C9E75100C4C.A99B64907A100E2E5F74ACE0BA586FB82F865CE3\u0026key=yt8\u0026lang=en", "name": { "simpleText": "English" }, "vssId": ".en", "languageCode": "en", "isTranslatable": true }, { "baseUrl": "https://www.youtube.com/api/timedtext?v=GJLlxj_dtq8\u0026caps=asr\u0026xoaf=5\u0026hl=en-GB\u0026ip=0.0.0.0\u0026ipbits=0\u0026expire=1681082354\u0026sparams=ip,ipbits,expire,v,caps,xoaf\u0026signature=13D068D838F3B1262B96D29751914C9E75100C4C.A99B64907A100E2E5F74ACE0BA586FB82F865CE3\u0026key=yt8\u0026kind=asr\u0026lang=en", "name": { "simpleText": "English (auto-generated)" }, "vssId": "a.en", "languageCode": "en", "kind": "asr", "isTranslatable": true }, { "baseUrl": "https://www.youtube.com/api/timedtext?v=GJLlxj_dtq8\u0026caps=asr\u0026xoaf=5\u0026hl=en-GB\u0026ip=0.0.0.0\u0026ipbits=0\u0026expire=1681082354\u0026sparams=ip,ipbits,expire,v,caps,xoaf\u0026signature=13D068D838F3B1262B96D29751914C9E75100C4C.A99B64907A100E2E5F74ACE0BA586FB82F865CE3\u0026key=yt8\u0026lang=de", "name": { "simpleText": "German" }, "vssId": ".de", "languageCode": "de", "isTranslatable": true }, { "baseUrl": "https://www.youtube.com/api/timedtext?v=GJLlxj_dtq8\u0026caps=asr\u0026xoaf=5\u0026hl=en-GB\u0026ip=0.0.0.0\u0026ipbits=0\u0026expire=1681082354\u0026sparams=ip,ipbits,expire,v,caps,xoaf\u0026signature=13D068D838F3B1262B96D29751914C9E75100C4C.A99B64907A100E2E5F74ACE0BA586FB82F865CE3\u0026key=yt8\u0026lang=hi", "name": { "simpleText": "Hindi" }, "vssId": ".hi", "languageCode": "hi", "isTranslatable": true }, { "baseUrl": "https://www.youtube.com/api/timedtext?v=GJLlxj_dtq8\u0026caps=asr\u0026xoaf=5\u0026hl=en-GB\u0026ip=0.0.0.0\u0026ipbits=0\u0026expire=1681082354\u0026sparams=ip,ipbits,expire,v,caps,xoaf\u0026signature=13D068D838F3B1262B96D29751914C9E75100C4C.A99B64907A100E2E5F74ACE0BA586FB82F865CE3\u0026key=yt8\u0026lang=ja", "name": { "simpleText": "Japanese" }, "vssId": ".ja", "languageCode": "ja", "isTranslatable": true }, { "baseUrl": "https://www.youtube.com/api/timedtext?v=GJLlxj_dtq8\u0026caps=asr\u0026xoaf=5\u0026hl=en-GB\u0026ip=0.0.0.0\u0026ipbits=0\u0026expire=1681082354\u0026sparams=ip,ipbits,expire,v,caps,xoaf\u0026signature=13D068D838F3B1262B96D29751914C9E75100C4C.A99B64907A100E2E5F74ACE0BA586FB82F865CE3\u0026key=yt8\u0026lang=ko", "name": { "simpleText": "Korean" }, "vssId": ".ko", "languageCode": "ko", "isTranslatable": true }, { "baseUrl": "https://www.youtube.com/api/timedtext?v=GJLlxj_dtq8\u0026caps=asr\u0026xoaf=5\u0026hl=en-GB\u0026ip=0.0.0.0\u0026ipbits=0\u0026expire=1681082354\u0026sparams=ip,ipbits,expire,v,caps,xoaf\u0026signature=13D068D838F3B1262B96D29751914C9E75100C4C.A99B64907A100E2E5F74ACE0BA586FB82F865CE3\u0026key=yt8\u0026lang=es", "name": { "simpleText": "Spanish" }, "vssId": ".es", "languageCode": "es", "isTranslatable": true }], "audioTracks": [{ "captionTrackIndices": [0, 1, 2, 4, 5, 6, 7, 8, 3], "defaultCaptionTrackIndex": 2, "visibility": "UNKNOWN", "hasDefaultTrack": true, "captionsInitialState": "CAPTIONS_INITIAL_STATE_OFF_RECOMMENDED" }], "translationLanguages": [{ "languageCode": "af", "languageName": { "simpleText": "Afrikaans" } }, { "languageCode": "ak", "languageName": { "simpleText": "Akan" } }, { "languageCode": "sq", "languageName": { "simpleText": "Albanian" } }, { "languageCode": "am", "languageName": { "simpleText": "Amharic" } }, { "languageCode": "ar", "languageName": { "simpleText": "Arabic" } }, { "languageCode": "hy", "languageName": { "simpleText": "Armenian" } }, { "languageCode": "as", "languageName": { "simpleText": "Assamese" } }, { "languageCode": "ay", "languageName": { "simpleText": "Aymara" } }, { "languageCode": "az", "languageName": { "simpleText": "Azerbaijani" } }, { "languageCode": "bn", "languageName": { "simpleText": "Bangla" } }, { "languageCode": "eu", "languageName": { "simpleText": "Basque" } }, { "languageCode": "be", "languageName": { "simpleText": "Belarusian" } }, { "languageCode": "bho", "languageName": { "simpleText": "Bhojpuri" } }, { "languageCode": "bs", "languageName": { "simpleText": "Bosnian" } }, { "languageCode": "bg", "languageName": { "simpleText": "Bulgarian" } }, { "languageCode": "my", "languageName": { "simpleText": "Burmese" } }, { "languageCode": "ca", "languageName": { "simpleText": "Catalan" } }, { "languageCode": "ceb", "languageName": { "simpleText": "Cebuano" } }, { "languageCode": "zh-Hans", "languageName": { "simpleText": "Chinese (Simplified)" } }, { "languageCode": "zh-Hant", "languageName": { "simpleText": "Chinese (Traditional)" } }, { "languageCode": "co", "languageName": { "simpleText": "Corsican" } }, { "languageCode": "hr", "languageName": { "simpleText": "Croatian" } }, { "languageCode": "cs", "languageName": { "simpleText": "Czech" } }, { "languageCode": "da", "languageName": { "simpleText": "Danish" } }, { "languageCode": "dv", "languageName": { "simpleText": "Divehi" } }, { "languageCode": "nl", "languageName": { "simpleText": "Dutch" } }, { "languageCode": "en", "languageName": { "simpleText": "English" } }, { "languageCode": "eo", "languageName": { "simpleText": "Esperanto" } }, { "languageCode": "et", "languageName": { "simpleText": "Estonian" } }, { "languageCode": "ee", "languageName": { "simpleText": "Ewe" } }, { "languageCode": "fil", "languageName": { "simpleText": "Filipino" } }, { "languageCode": "fi", "languageName": { "simpleText": "Finnish" } }, { "languageCode": "fr", "languageName": { "simpleText": "French" } }, { "languageCode": "gl", "languageName": { "simpleText": "Galician" } }, { "languageCode": "lg", "languageName": { "simpleText": "Ganda" } }, { "languageCode": "ka", "languageName": { "simpleText": "Georgian" } }, { "languageCode": "de", "languageName": { "simpleText": "German" } }, { "languageCode": "el", "languageName": { "simpleText": "Greek" } }, { "languageCode": "gn", "languageName": { "simpleText": "Guarani" } }, { "languageCode": "gu", "languageName": { "simpleText": "Gujarati" } }, { "languageCode": "ht", "languageName": { "simpleText": "Haitian Creole" } }, { "languageCode": "ha", "languageName": { "simpleText": "Hausa" } }, { "languageCode": "haw", "languageName": { "simpleText": "Hawaiian" } }, { "languageCode": "iw", "languageName": { "simpleText": "Hebrew" } }, { "languageCode": "hi", "languageName": { "simpleText": "Hindi" } }, { "languageCode": "hmn", "languageName": { "simpleText": "Hmong" } }, { "languageCode": "hu", "languageName": { "simpleText": "Hungarian" } }, { "languageCode": "is", "languageName": { "simpleText": "Icelandic" } }, { "languageCode": "ig", "languageName": { "simpleText": "Igbo" } }, { "languageCode": "id", "languageName": { "simpleText": "Indonesian" } }, { "languageCode": "ga", "languageName": { "simpleText": "Irish" } }, { "languageCode": "it", "languageName": { "simpleText": "Italian" } }, { "languageCode": "ja", "languageName": { "simpleText": "Japanese" } }, { "languageCode": "jv", "languageName": { "simpleText": "Javanese" } }, { "languageCode": "kn", "languageName": { "simpleText": "Kannada" } }, { "languageCode": "kk", "languageName": { "simpleText": "Kazakh" } }, { "languageCode": "km", "languageName": { "simpleText": "Khmer" } }, { "languageCode": "rw", "languageName": { "simpleText": "Kinyarwanda" } }, { "languageCode": "ko", "languageName": { "simpleText": "Korean" } }, { "languageCode": "kri", "languageName": { "simpleText": "Krio" } }, { "languageCode": "ku", "languageName": { "simpleText": "Kurdish" } }, { "languageCode": "ky", "languageName": { "simpleText": "Kyrgyz" } }, { "languageCode": "lo", "languageName": { "simpleText": "Lao" } }, { "languageCode": "la", "languageName": { "simpleText": "Latin" } }, { "languageCode": "lv", "languageName": { "simpleText": "Latvian" } }, { "languageCode": "ln", "languageName": { "simpleText": "Lingala" } }, { "languageCode": "lt", "languageName": { "simpleText": "Lithuanian" } }, { "languageCode": "lb", "languageName": { "simpleText": "Luxembourgish" } }, { "languageCode": "mk", "languageName": { "simpleText": "Macedonian" } }, { "languageCode": "mg", "languageName": { "simpleText": "Malagasy" } }, { "languageCode": "ms", "languageName": { "simpleText": "Malay" } }, { "languageCode": "ml", "languageName": { "simpleText": "Malayalam" } }, { "languageCode": "mt", "languageName": { "simpleText": "Maltese" } }, { "languageCode": "mi", "languageName": { "simpleText": "MƒÅori" } }, { "languageCode": "mr", "languageName": { "simpleText": "Marathi" } }, { "languageCode": "mn", "languageName": { "simpleText": "Mongolian" } }, { "languageCode": "ne", "languageName": { "simpleText": "Nepali" } }, { "languageCode": "nso", "languageName": { "simpleText": "Northern Sotho" } }, { "languageCode": "no", "languageName": { "simpleText": "Norwegian" } }, { "languageCode": "ny", "languageName": { "simpleText": "Nyanja" } }, { "languageCode": "or", "languageName": { "simpleText": "Odia" } }, { "languageCode": "om", "languageName": { "simpleText": "Oromo" } }, { "languageCode": "ps", "languageName": { "simpleText": "Pashto" } }, { "languageCode": "fa", "languageName": { "simpleText": "Persian" } }, { "languageCode": "pl", "languageName": { "simpleText": "Polish" } }, { "languageCode": "pt", "languageName": { "simpleText": "Portuguese" } }, { "languageCode": "pa", "languageName": { "simpleText": "Punjabi" } }, { "languageCode": "qu", "languageName": { "simpleText": "Quechua" } }, { "languageCode": "ro", "languageName": { "simpleText": "Romanian" } }, { "languageCode": "ru", "languageName": { "simpleText": "Russian" } }, { "languageCode": "sm", "languageName": { "simpleText": "Samoan" } }, { "languageCode": "sa", "languageName": { "simpleText": "Sanskrit" } }, { "languageCode": "gd", "languageName": { "simpleText": "Scottish Gaelic" } }, { "languageCode": "sr", "languageName": { "simpleText": "Serbian" } }, { "languageCode": "sn", "languageName": { "simpleText": "Shona" } }, { "languageCode": "sd", "languageName": { "simpleText": "Sindhi" } }, { "languageCode": "si", "languageName": { "simpleText": "Sinhala" } }, { "languageCode": "sk", "languageName": { "simpleText": "Slovak" } }, { "languageCode": "sl", "languageName": { "simpleText": "Slovenian" } }, { "languageCode": "so", "languageName": { "simpleText": "Somali" } }, { "languageCode": "st", "languageName": { "simpleText": "Southern Sotho" } }, { "languageCode": "es", "languageName": { "simpleText": "Spanish" } }, { "languageCode": "su", "languageName": { "simpleText": "Sundanese" } }, { "languageCode": "sw", "languageName": { "simpleText": "Swahili" } }, { "languageCode": "sv", "languageName": { "simpleText": "Swedish" } }, { "languageCode": "tg", "languageName": { "simpleText": "Tajik" } }, { "languageCode": "ta", "languageName": { "simpleText": "Tamil" } }, { "languageCode": "tt", "languageName": { "simpleText": "Tatar" } }, { "languageCode": "te", "languageName": { "simpleText": "Telugu" } }, { "languageCode": "th", "languageName": { "simpleText": "Thai" } }, { "languageCode": "ti", "languageName": { "simpleText": "Tigrinya" } }, { "languageCode": "ts", "languageName": { "simpleText": "Tsonga" } }, { "languageCode": "tr", "languageName": { "simpleText": "Turkish" } }, { "languageCode": "tk", "languageName": { "simpleText": "Turkmen" } }, { "languageCode": "uk", "languageName": { "simpleText": "Ukrainian" } }, { "languageCode": "ur", "languageName": { "simpleText": "Urdu" } }, { "languageCode": "ug", "languageName": { "simpleText": "Uyghur" } }, { "languageCode": "uz", "languageName": { "simpleText": "Uzbek" } }, { "languageCode": "vi", "languageName": { "simpleText": "Vietnamese" } }, { "languageCode": "cy", "languageName": { "simpleText": "Welsh" } }, { "languageCode": "fy", "languageName": { "simpleText": "Western Frisian" } }, { "languageCode": "xh", "languageName": { "simpleText": "Xhosa" } }, { "languageCode": "yi", "languageName": { "simpleText": "Yiddish" } }, { "languageCode": "yo", "languageName": { "simpleText": "Yoruba" } }, { "languageCode": "zu", "languageName": { "simpleText": "Zulu" } }], "defaultAudioTrackIndex": 0 } }, "videoDetails": { "videoId": "GJLlxj_dtq8", "#
        }
    }
    #[test]
    fn test_caption() {
        let c = Config::default();
        HTML.captions(c.parser.from, c.parser.to).unwrap();
    }
}
